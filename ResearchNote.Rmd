---
title: "Research Note"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
if (!require(pacman)) install.packages("pacman")
library(pacman)
p_load(
  qs,
  rvest,
  tidyverse,
  pinyin,
  xlsx
)
set.seed(19960916)
setwd('/Users/sunyufei/Documents/GitHub/Covid19Policy')
options(scipen = 200)
```

This is a notebook recording the decisions for the project in collaboration with Master Jiajing Chen to study the Covid-19 mandatory policy during the Spring Festival of 2021 in prefecture-level cities in China.

```{R CrawlerPolicy}
citycode <- read_html("http://www.bendibao.com/index.htm") %>% 
  html_nodes("#city-list a") %>% 
  html_attrs()
cityname <- read_html("http://www.bendibao.com/index.htm") %>% 
  html_nodes("#city-list a") %>% 
  html_text()
CityForce <- as.data.frame(cityname)
CityForce$citycode <- CityForce$cityname
a <- 1
for (c in citycode){
  CityForce$citycode[a] <- c
  a <- a + 1
  print(c)
}

CityForce$duplicated <- duplicated(CityForce$cityname)

CityForce <- CityForce %>% 
  dplyr::filter(duplicated != TRUE) %>% 
  dplyr::filter(citycode != "http://kunshan.bendibao.com/") %>% 
  dplyr::filter(citycode != "http://hk.bendibao.com/") %>% 
  dplyr::filter(citycode != "http://am.bendibao.com/") %>% 
  dplyr::select(-duplicated)

CityForce$citycode[8] <- "http://tj.bendibao.com/"
CityForce$citycode[9] <- "http://cq.bendibao.com/"
CityForce$citycode[92] <- "http://zz.bendibao.com/"
CityForce$citycode[257] <- "http://dl.bendibao.com/"

a <- 1
for (c in CityForce$citycode){
forcehtml <- read_html(paste0(c, "news/gelizhengce/all.php?leavecity=hk"), encoding = "UTF-8")
forcetext <- forcehtml %>% 
  html_nodes(".list-primary-item+ .list-primary-item .result") %>% 
  html_text()
CityForce$ForceText[a] <- forcetext
a = a + 1
print(c)
}

qsave(CityForce, './data/foecetext20210206.qs')
write.xlsx(CityForce, './data/foecetext20210206.xlsx')
# 2021.2.6手动更新数据，补充数据分为三类：灰色标注，县级市，删去之即可；黄色标注，已补充，请更新；红色标注，没有明确的防疫信息
# 请注意，拉萨市已更新隔离政策，请重新标注；
# 请注意，新疆自治区除乌鲁木齐、昌吉明确隔离政策和几个地级市完全没有发布政策外，其他地市均为搪塞政策，我们要单独分类或致电当地卫健委查询
```